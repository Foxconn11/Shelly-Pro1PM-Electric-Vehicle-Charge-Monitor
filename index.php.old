<?php
// DB Settings
$host = "localhost";
$user = "EVShelly";
$pass = "Fqt[.tyvBaeZY@Ts";
$db = "EVShelly";

// Verbindung
$conn = new mysqli($host, $user, $pass, $db);
if ($conn->connect_error) die("DB Verbindung fehlgeschlagen: " . $conn->connect_error);

// Tabelle abrufen
$result = $conn->query("SELECT * FROM ladehistorie ORDER BY datum DESC");
?>

<!DOCTYPE html>
<html>
<head>
    <title>Ladehistorie Elektroauto</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h2>Ladehistorie Elektroauto</h2>

<form id="ladeForm">
    <label>Kilometerstand:</label>
    <input type="number" name="kmstand" id="kmstand" required>
    <button type="button" id="abrufen">Shelly-KWh abrufen & speichern</button>
</form>

<table border="1" cellpadding="5" cellspacing="0" id="historie">
<tr>
    <th>Datum</th>
    <th>km</th>
    <th>kWh</th>
    <th>Geladene kWh</th>
    <th>Verbrauch kWh/100km</th>
</tr>
<?php
while($row = $result->fetch_assoc()) {
    echo "<tr>
    <td>{$row['datum']}</td>
    <td>{$row['kmstand']}</td>
    <td>".number_format($row['kwh'],2)."</td>
    <td>".number_format($row['geladene_kwh'],2)."</td>
    <td>".number_format($row['verbrauch'],2)."</td>
    </tr>";
}
$conn->close();
?>
</table>

<script>
$(document).ready(function() {
    $("#abrufen").click(function() {
        let kmstand = $("#kmstand").val();
        if(kmstand == "") { alert("Bitte Kilometerstand eingeben"); return; }

        $.post("eintragen.php", {kmstand: kmstand}, function(data) {
            $("#historie").html(data); // Tabelle aktualisieren
            $("#kmstand").val(""); // Feld leeren
        });
    });
});
</script>

</body>
</html>
